<!DOCTYPE html>
<html lang="en">
<head>
    <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css' rel='stylesheet' />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Mobile map</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100vw;
        }
    </style>
</head>
<body>
    <button type ="button" id="ParticipantID">Participant ID</button>
    <button type ="button" id="startRecording">Start Recording</button>
    <button type ="button" id="stopRecording" disabled>Stop Recording</button>
    <button type ="button" id="Download_Locations" disabled>Download Locations</button>
    <button type ="button" id="Download_Interactions" disabled>Download Interactions</button>
    
    <div id = "map"></div>
    <script>
        /* MAP */
        // Initialize the leaflet map
        L.mapbox.accessToken = 'pk.eyJ1IjoieXFpbmciLCJhIjoiY2xsdzJhMm1mMXpodTNjcHZyc29zaGsxYSJ9.iijVfH5AG9g1Scb_zBYiYA';
        var map = L.map('map').setView([47.40460386239871, 8.54384625978079], 18);

        var corner1 = L.latLng(47.403934453603725, 8.545603106349375),
        corner2 = L.latLng(47.40670829225139, 8.542888710894422),
        mybounds = L.latLngBounds(corner1, corner2);

        L.tileLayer('https://api.mapbox.com/styles/v1/yqing/cllwfkv1500fd01qu7knch522/tiles/256/{z}/{x}/{y}@2x?access_token=' + L.mapbox.accessToken,{
            tileSize: 512,
            //bounds: mybounds,
            zoomOffset: -1,
            maxZoom: 22,
            attribution:'© <a href="https://www.mapbox.com/contribute/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        // Display the route on the map
        var myStyle = {
            "color": "#2b6999",
            "weight": 8,
            "opacity": 1
        };
        var myGeoJSON = {"type": "FeatureCollection", "features": [{"type": "Feature", "geometry": {"type": "LineString", "coordinates": [[8.54516126, 47.4042067], [8.54539571, 47.40459743], [8.54539592, 47.40463866], [8.54535435, 47.40466317], [8.54532359, 47.40467582], [8.5442842, 47.40494541], [8.54446928, 47.405333], [8.54553219, 47.40521497], [8.54590905, 47.40520771], [8.54589698, 47.40557713], [8.5452452, 47.40567516], [8.54326881, 47.4063037], [8.54266823, 47.40542678], [8.54264543, 47.40535417], [8.54268969, 47.40511817], [8.54279698, 47.40514359]]}, "id": "232ee6a8-c4fc-4775-a7e6-a033cf8e6e9b", "properties": {"name": ""}}]};
        L.geoJSON(myGeoJSON, {
            style: myStyle
        }).addTo(map);
        // Display the start point & detination
        var StartPoint = L.circle([47.4042067, 8.54516126],{color: '#000000', fillColor: '#000000', fillOpacity: 1, radius: 3}).addTo(map)
        var myIcon = L.icon({
            iconUrl: 'my-icon.png',
            iconSize: [30, 30]
        });
        L.marker([47.40519400, 8.54285708], {icon: myIcon}).addTo(map);
        
        /* RECORDING CONTROL */
        // Initialize variables for location recording
        let recording = false;
        const recordedLocations = [];
        const recordedInteractions = [];
        var participant;

        // Function to start recording
        document.getElementById('ParticipantID').addEventListener('click', () => {
            participant = prompt('Please input participant ID', 999);
        });

        document.getElementById('startRecording').addEventListener('click', () => {
            recording = true;
            document.getElementById('startRecording').disabled = true;
            document.getElementById('ParticipantID').disabled = true;
            document.getElementById('stopRecording').disabled = false;
            document.getElementById('Download_Locations').disabled = true;
            document.getElementById('Download_Interactions').disabled = true;
            startRecording();
        });

        // Function to stop recording
        document.getElementById('stopRecording').addEventListener('click', () => {
            recording = false;
            document.getElementById('ParticipantID').disabled = false;
            document.getElementById('startRecording').disabled = false;
            document.getElementById('stopRecording').disabled = true;
            document.getElementById('Download_Locations').disabled = false;
            document.getElementById('Download_Interactions').disabled = false;
            stopRecording();
        });

        // Funcation to download 
        document.getElementById('Download_Locations').addEventListener('click', () => {
            downloadLocations();
        });

        document.getElementById('Download_Interactions').addEventListener('click', () => {
            downloadInteractionData();
        });
       
        /* LOCATION */
        //Real time location tracker
        if (! navigator.geolocation){
            console.log('your browser does not support the geolocation')
        } else {
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(getPosition)
            }, 500);
        }
        
        var circle;
        // Function to get and record current location
        function getPosition(position){
            var lat = position.coords.latitude
            var long = position.coords.longitude
            var accuracy = position.coords.accuracy

            if (recording) {
                var time = Date.now();
                recordedLocations.push({ lat, long, time, accuracy});
            }

            if (circle){
                map.removeLayer(circle)
            }

            // Display the closest point on the route
            
            var desiredLocation = {
                "type": "Feature",
                "geometry": {
                "type": "Point",
                "coordinates": [long, lat] 
                }
            };
            var nearestPointOnLine = turf.pointOnLine(myGeoJSON, desiredLocation);
            var nearestPointCoords = nearestPointOnLine.geometry.coordinates;
            circle = L.circle([nearestPointCoords[1],nearestPointCoords[0]],{color: '#c65247', fillColor: '#c65247', fillOpacity: 1, radius: 5}).addTo(map)      
        }

        /* INTERACTION */
        function startRecording() {
            map.on('zoomend', recordZoom);
            map.on('moveend', recordPan);
        }

        function recordZoom(event) {
        if (recording) {
            // Record zoom interaction
            var ZoomTime = Date.now();
            recordedInteractions.push({
            type: 'zoom',
            zoomLevel: event.target.getZoom(), ZoomTime,
            });
         }
        }

        function recordPan(event) {
        if (recording) {
            // Record pan interaction
            var PanTime = Date.now();
            recordedInteractions.push({
            type: 'pan',
            latlng: event.target.getCenter(),PanTime,
            });
         }
        }

        function stopRecording() {
            map.off('zoomend', recordZoom);
            map.off('moveend', recordPan);
            //console.log('Recording stopped');
        }

        /* DOWNLOAD */
        // Function to download recorded locations as a text file
        function downloadLocations() {
            const data = JSON.stringify(recordedLocations);
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = participant + '_location.txt';
            a.click();
        }

        // Function to download recorded interaction data as a text file
        function downloadInteractionData() {
            const interactionData = JSON.stringify(recordedInteractions);
            const blob = new Blob([interactionData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = participant + '_interaction.txt';
            a.click();
        }
    </script>
    
</body>
</html>